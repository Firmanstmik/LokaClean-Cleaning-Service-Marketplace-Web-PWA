
// Prisma schema for LokaClean.
// IMPORTANT: This schema is designed to match the provided ERD strictly.

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  output   = "../node_modules/@prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [postgis]
}

// Roles used for JWT/RBAC.
enum Role {
  USER
  ADMIN
  CLEANER
}

enum OrderStatus {
  PENDING
  PROCESSING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  QRIS
  DANA
  TRANSFER
  CASH
}

enum PaymentStatus {
  PENDING
  PAID
}

model User {
  id                Int      @id @default(autoincrement())
  full_name         String
  email             String   @unique
  phone_number      String
  // Stored bcrypt hash for user login.
  password_hash     String?
  profile_photo     String?
  
  // Basic location for users (optional default)
  default_latitude  Float?
  default_longitude Float?
  
  role              Role     @default(USER)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relationships
  pesanan       Pesanan[]
  notifications Notification[]
  pushSubscriptions PushSubscription[]
  savedAddresses SavedAddress[]
  
  // If user is a cleaner, this profile exists
  cleanerProfile CleanerProfile?
}

model SavedAddress {
  id        Int      @id @default(autoincrement())
  user_id   Int
  label     String   // home, office, other, custom...
  is_primary Boolean @default(false)
  address   String
  street    String?
  village   String?
  district  String?
  city      String?
  notes     String?
  floor_number String?
  building_name String?
  gate_photo_url String?
  latitude  Float
  longitude Float
  
  // PostGIS Geography Point
  location  Unsupported("geography(Point, 4326)")?
  
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id])
  
  @@index([user_id])
}

model Admin {
  id           Int      @id @default(autoincrement())
  full_name    String
  email        String   @unique
  phone_number String?  @unique
  password     String
  role         Role     @default(ADMIN)
  created_at   DateTime @default(now())

  // Relationships
  pesanan Pesanan[]
}

model CleanerProfile {
  id            Int     @id @default(autoincrement())
  user_id       Int     @unique
  rating        Float   @default(5.0)
  active_orders Int     @default(0)
  is_active     Boolean @default(true)
  
  // PostGIS Geography Point (Long, Lat)
  // We use Unsupported for raw PostGIS types if strict typing isn't available yet,
  // or we can handle it via raw SQL.
  // For simplicity in Prisma, we often keep lat/lng as floats for application use,
  // and use a separate raw SQL migration to add the geography column 'location'.
  // However, since we need to use it in queries, we'll rely on the 'location' column 
  // existing in the DB via migration.
  
  // location    Unsupported("geography(Point, 4326)")? 
  
  location    Unsupported("geography(Point, 4326)")? 

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id])
}

model ServiceArea {
  id   Int    @id @default(autoincrement())
  name String
  
  // PostGIS Geography Polygon
  // area Unsupported("geography(Polygon, 4326)")
  
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model PaketCleaning {
  id                 Int      @id @default(autoincrement())
  name               String
  name_en            String?
  description        String
  description_en     String?
  price              Int
  estimated_duration Int
  image              String?  // Optional image path for package
  category           String   @default("SERVICE") // SERVICE, PRODUCT
  stock              Int      @default(100)
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  // Relationships
  pesanan Pesanan[]
}

model Pesanan {
  id                 Int         @id @default(autoincrement())
  order_number       Int         @unique // Sequential order number (1, 2, 3, ...) - stays consistent even if orders are deleted
  user_id            Int
  admin_id           Int?
  paket_id           Int
  status             OrderStatus @default(PENDING)
  room_photo_before  String
  room_photo_after   String?
  
  // Snapshot of location at time of order
  location_latitude  Float
  location_longitude Float
  address            String
  
  // location Unsupported("geography(Point, 4326)")?
  location Unsupported("geography(Point, 4326)")?

  scheduled_date     DateTime
  
  // Price details
  base_price         Int      @default(50000)
  distance_price     Int      @default(0)
  extra_price        Int      @default(0)
  surge_multiplier   Float    @default(1.0)
  total_price        Int      
  estimated_eta      Int?     // In minutes

  extra_services     Json?

  created_at         DateTime    @default(now())
  updated_at         DateTime    @updatedAt

  // Relationships (strictly following ERD cardinalities)
  user  User          @relation(fields: [user_id], references: [id])
  admin Admin?        @relation(fields: [admin_id], references: [id])
  paket PaketCleaning @relation(fields: [paket_id], references: [id])

  // Prisma cannot enforce a required 1:1 from Pesanan -> Pembayaran at the DB level
  // because the foreign key lives on Pembayaran. We keep this optional in schema and
  // enforce "must exist" in application logic when creating an order.
  pembayaran    Pembayaran?
  rating        Rating?
  tip           Tip?
  notifications Notification[]

  @@index([user_id])
  @@index([admin_id])
  @@index([paket_id])
}

model Pembayaran {
  id                Int           @id @default(autoincrement())
  pesanan_id        Int           @unique
  method            PaymentMethod
  amount            Int
  status            PaymentStatus @default(PENDING)
  midtrans_order_id String? // Midtrans order ID (for NON-CASH payments)
  created_at        DateTime      @default(now())

  pesanan Pesanan @relation(fields: [pesanan_id], references: [id])
}

model Rating {
  id           Int      @id @default(autoincrement())
  pesanan_id   Int      @unique
  rating_value Int
  review       String?
  created_at   DateTime @default(now())

  pesanan Pesanan @relation(fields: [pesanan_id], references: [id])
}

model Tip {
  id         Int      @id @default(autoincrement())
  pesanan_id Int      @unique
  amount     Int
  created_at DateTime @default(now())

  pesanan Pesanan @relation(fields: [pesanan_id], references: [id])
}

model Notification {
  id         Int      @id @default(autoincrement())
  user_id    Int
  pesanan_id Int?
  title      String
  message    String
  is_read    Boolean  @default(false)
  created_at DateTime @default(now())

  user    User     @relation(fields: [user_id], references: [id])
  pesanan Pesanan? @relation(fields: [pesanan_id], references: [id])

  @@index([user_id])
  @@index([pesanan_id])
}

model PushSubscription {
  id        Int      @id @default(autoincrement())
  user_id   Int
  endpoint  String   @unique
  p256dh    String
  auth      String
  created_at DateTime @default(now())

  user      User     @relation(fields: [user_id], references: [id])

  @@index([user_id])
}
